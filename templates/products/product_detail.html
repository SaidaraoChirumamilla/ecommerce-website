{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - E-Commerce Store{% endblock %}

{% block extra_css %}
<style>
    .product-image-main {
        height: 400px;
        object-fit: cover;
        border-radius: 15px;
        border: 2px solid #f8f9fa;
    }
    
    .product-thumbnail {
        height: 80px;
        width: 80px;
        object-fit: cover;
        border-radius: 10px;
        border: 2px solid #e9ecef;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .product-thumbnail:hover,
    .product-thumbnail.active {
        border-color: #667eea;
        transform: scale(1.05);
    }
    
    .price-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .price-current {
        font-size: 2rem;
        font-weight: bold;
        color: #e74c3c;
    }
    
    .price-original {
        font-size: 1.2rem;
        text-decoration: line-through;
        color: #6c757d;
    }
    
    .discount-badge {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .rating-section {
        background: #fff;
        border: 2px solid #f8f9fa;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .rating-stars {
        color: #ffc107;
        font-size: 1.2rem;
    }
    
    .btn-add-cart {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 15px;
        padding: 15px 30px;
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .btn-add-cart:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    .btn-buy-now {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        border: none;
        border-radius: 15px;
        padding: 15px 30px;
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .btn-buy-now:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(243, 156, 18, 0.4);
        color: white;
    }
    
    .quantity-selector {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 10px 15px;
        width: 100px;
        text-align: center;
        font-weight: 500;
    }
    
    .quantity-selector:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }
    
    .variant-option {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }
    
    .variant-option:hover,
    .variant-option.selected {
        border-color: #667eea;
        background: #f8f9ff;
        color: #667eea;
    }
    
    .product-tabs {
        border-bottom: 2px solid #f8f9fa;
        margin-bottom: 20px;
    }
    
    .product-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: #6c757d;
        font-weight: 500;
        padding: 15px 20px;
    }
    
    .product-tabs .nav-link.active {
        border-bottom-color: #667eea;
        color: #667eea;
        background: none;
    }
    
    .review-card {
        border: 2px solid #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .review-card:hover {
        border-color: #e9ecef;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stock-indicator {
        padding: 10px 15px;
        border-radius: 10px;
        font-weight: 500;
        margin-bottom: 15px;
    }
    
    .stock-in {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .stock-low {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .stock-out {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .feature-list {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .feature-item {
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .feature-item:last-child {
        border-bottom: none;
    }
    
    .related-product {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        text-decoration: none;
        color: inherit;
    }
    
    .related-product:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        color: inherit;
    }
    
    .related-product-image {
        height: 150px;
        object-fit: cover;
        border-radius: 15px 15px 0 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'product_list' %}">Products</a></li>
            <li class="breadcrumb-item"><a href="?category={{ product.category.slug }}">{{ product.category.name }}</a></li>
            <li class="breadcrumb-item active">{{ product.name }}</li>
        </ol>
    </nav>
    
    <div class="row">
        <!-- Product Images -->
        <div class="col-lg-6 mb-4">
            <div class="position-sticky" style="top: 100px;">
                <!-- Main Image -->
                <div class="mb-3">
                    {% if product.get_main_image %}
                        <img src="{{ product.get_main_image }}" class="w-100 product-image-main" alt="{{ product.name }}" id="mainImage">
                    {% else %}
                        <div class="product-image-main w-100 bg-light d-flex align-items-center justify-content-center">
                            <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Thumbnail Images -->
                <div class="d-flex gap-2 flex-wrap">
                    {% for image in images %}
                        <img src="{{ image.image.url }}" class="product-thumbnail {% if forloop.first %}active{% endif %}" 
                             alt="{{ image.alt_text }}" onclick="changeMainImage(this.src)">
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Product Details -->
        <div class="col-lg-6">
            <div class="mb-2">
                <span class="badge bg-primary">{{ product.brand.name }}</span>
                {% if product.is_featured %}
                    <span class="badge bg-warning text-dark ms-2">Featured</span>
                {% endif %}
                {% if product.is_bestseller %}
                    <span class="badge bg-success ms-2">Bestseller</span>
                {% endif %}
                {% if product.is_new_arrival %}
                    <span class="badge bg-info ms-2">New</span>
                {% endif %}
            </div>
            
            <h1 class="h2 fw-bold mb-3">{{ product.name }}</h1>
            
            <!-- Rating Section -->
            <div class="rating-section">
                <div class="d-flex align-items-center gap-3">
                    <div class="rating-stars">
                        {% for i in "12345" %}
                            {% if forloop.counter <= product.average_rating %}
                                <i class="bi bi-star-fill"></i>
                            {% else %}
                                <i class="bi bi-star"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="fw-semibold">{{ product.average_rating|floatformat:1 }}</span>
                    <a href="#reviews" class="text-decoration-none">({{ product.review_count }} reviews)</a>
                </div>
            </div>
            
            <!-- Price Section -->
            <div class="price-section">
                <div class="d-flex align-items-center gap-3 mb-2">
                    <span class="price-current">${{ product.price }}</span>
                    {% if product.original_price and product.discount_percentage > 0 %}
                        <span class="price-original">${{ product.original_price }}</span>
                        <span class="discount-badge">{{ product.discount_percentage }}% OFF</span>
                    {% endif %}
                </div>
                {% if product.free_shipping %}
                    <p class="mb-0 text-success">
                        <i class="bi bi-truck"></i> Free Shipping
                    </p>
                {% endif %}
            </div>
            
            <!-- Stock Status -->
            {% if product.is_in_stock %}
                {% if product.is_low_stock %}
                    <div class="stock-indicator stock-low">
                        <i class="bi bi-exclamation-triangle"></i>
                        Only {{ product.stock_quantity }} left in stock - order soon!
                    </div>
                {% else %}
                    <div class="stock-indicator stock-in">
                        <i class="bi bi-check-circle"></i>
                        In Stock ({{ product.stock_quantity }} available)
                    </div>
                {% endif %}
            {% else %}
                <div class="stock-indicator stock-out">
                    <i class="bi bi-x-circle"></i>
                    Currently out of stock
                </div>
            {% endif %}
            
            <!-- Product Variants -->
            {% if variants %}
                {% regroup variants by variant_type as variant_groups %}
                {% for variant_group in variant_groups %}
                    <div class="mb-3">
                        <h6 class="fw-semibold">{{ variant_group.grouper }}:</h6>
                        <div class="d-flex flex-wrap">
                            {% for variant in variant_group.list %}
                                <div class="variant-option" data-variant-id="{{ variant.id }}" 
                                     data-price-adjustment="{{ variant.price_adjustment }}">
                                    {{ variant.name }}
                                    {% if variant.price_adjustment != 0 %}
                                        <small class="text-muted">(+${{ variant.price_adjustment }})</small>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
            
            <!-- Quantity and Add to Cart -->
            {% if product.is_in_stock %}
                <div class="mb-4">
                    <div class="row align-items-end">
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-semibold">Quantity:</label>
                            <input type="number" class="form-control quantity-selector" 
                                   id="quantity" value="1" min="1" max="{{ product.max_order_quantity }}">
                        </div>
                        <div class="col-md-9 mb-3">
                            <div class="d-flex gap-2">
                                <button class="btn btn-add-cart flex-fill" onclick="addToCart()">
                                    <i class="bi bi-cart-plus me-2"></i>Add to Cart
                                </button>
                                <button class="btn btn-buy-now flex-fill">
                                    <i class="bi bi-lightning me-2"></i>Buy Now
                                </button>
                                <button class="btn btn-outline-danger" onclick="toggleWishlist()">
                                    <i class="bi bi-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Short Description -->
            <div class="mb-4">
                <p class="lead">{{ product.short_description }}</p>
            </div>
            
            <!-- Key Features -->
            {% if product.features %}
                <div class="feature-list">
                    <h6 class="fw-bold mb-3">Key Features:</h6>
                    {% for feature in product.features %}
                        <div class="feature-item">
                            <i class="bi bi-check-circle text-success"></i>
                            <span>{{ feature }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- Shipping & Returns -->
            <div class="border rounded-3 p-3 mb-4">
                <div class="row text-center">
                    <div class="col-4">
                        <i class="bi bi-truck text-primary mb-2 d-block" style="font-size: 1.5rem;"></i>
                        <small class="fw-semibold">Fast Delivery</small>
                    </div>
                    <div class="col-4">
                        <i class="bi bi-arrow-return-left text-primary mb-2 d-block" style="font-size: 1.5rem;"></i>
                        <small class="fw-semibold">Easy Returns</small>
                    </div>
                    <div class="col-4">
                        <i class="bi bi-shield-check text-primary mb-2 d-block" style="font-size: 1.5rem;"></i>
                        <small class="fw-semibold">Secure Payment</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Product Details Tabs -->
    <div class="row mt-5">
        <div class="col-12">
            <ul class="nav nav-tabs product-tabs" id="productTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#description">Description</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#specifications">Specifications</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#reviews">Reviews ({{ product.review_count }})</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#shipping">Shipping & Returns</a>
                </li>
            </ul>
            
            <div class="tab-content mt-4">
                <!-- Description Tab -->
                <div class="tab-pane fade show active" id="description">
                    <div class="row">
                        <div class="col-lg-8">
                            <h5 class="fw-bold mb-3">Product Description</h5>
                            <p>{{ product.description|linebreaks }}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Specifications Tab -->
                <div class="tab-pane fade" id="specifications">
                    <h5 class="fw-bold mb-3">Technical Specifications</h5>
                    {% if product.specifications %}
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                {% for key, value in product.specifications.items %}
                                    <tr>
                                        <td class="fw-semibold bg-light" style="width: 30%;">{{ key }}</td>
                                        <td>{{ value }}</td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No specifications available.</p>
                    {% endif %}
                </div>
                
                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="reviews">
                    <h5 class="fw-bold mb-4">Customer Reviews</h5>
                    
                    {% if reviews %}
                        {% for review in reviews %}
                            <div class="review-card">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <div class="rating-stars mb-1">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= review.rating %}
                                                    <i class="bi bi-star-fill"></i>
                                                {% else %}
                                                    <i class="bi bi-star"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <h6 class="fw-bold mb-1">{{ review.title }}</h6>
                                        <small class="text-muted">
                                            by {{ review.user.get_full_name|default:review.user.username }} 
                                            on {{ review.created_at|date:"F d, Y" }}
                                            {% if review.is_verified_purchase %}
                                                <span class="badge bg-success ms-2">Verified Purchase</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                                <p class="mb-0">{{ review.review }}</p>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-chat-square-text display-4 text-muted"></i>
                            <h5 class="mt-3">No reviews yet</h5>
                            <p class="text-muted">Be the first to review this product!</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Shipping Tab -->
                <div class="tab-pane fade" id="shipping">
                    <h5 class="fw-bold mb-3">Shipping & Returns</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-semibold">Shipping Information</h6>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-truck text-primary me-2"></i>Standard Shipping: 3-5 business days</li>
                                <li><i class="bi bi-lightning text-warning me-2"></i>Express Shipping: 1-2 business days</li>
                                {% if product.free_shipping %}
                                    <li><i class="bi bi-gift text-success me-2"></i>Free shipping on this item</li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-semibold">Return Policy</h6>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-arrow-return-left text-info me-2"></i>30-day return window</li>
                                <li><i class="bi bi-shield-check text-success me-2"></i>Free returns</li>
                                <li><i class="bi bi-box text-muted me-2"></i>Item must be in original condition</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Related Products -->
    {% if related_products %}
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="fw-bold mb-4">You might also like</h3>
            <div class="row">
                {% for related_product in related_products %}
                    <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
                        <a href="{{ related_product.get_absolute_url }}" class="related-product card">
                            {% if related_product.get_main_image %}
                                <img src="{{ related_product.get_main_image }}" class="related-product-image" alt="{{ related_product.name }}">
                            {% else %}
                                <div class="related-product-image bg-light d-flex align-items-center justify-content-center">
                                    <i class="bi bi-image text-muted"></i>
                                </div>
                            {% endif %}
                            <div class="card-body p-3">
                                <h6 class="card-title small mb-2">{{ related_product.name|truncatechars:30 }}</h6>
                                <p class="card-text small text-primary fw-bold mb-0">${{ related_product.price }}</p>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedVariants = {};
let basePrice = {{ product.price }};

function changeMainImage(src) {
    document.getElementById('mainImage').src = src;
    
    // Update active thumbnail
    document.querySelectorAll('.product-thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
    });
    event.target.classList.add('active');
}

function addToCart() {
    if (!{{ user.is_authenticated|yesno:"true,false" }}) {
        alert('Please login to add items to cart');
        window.location.href = "{% url 'login' %}";
        return;
    }
    
    const quantity = parseInt(document.getElementById('quantity').value);
    const selectedVariant = Object.keys(selectedVariants).length > 0 ? selectedVariants : null;
    
    fetch('{% url "add_to_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            product_id: {{ product.id }},
            variant_id: selectedVariant ? Object.values(selectedVariant)[0] : null,
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            updateCartCount();
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        showToast('An error occurred. Please try again.', 'error');
    });
}

function toggleWishlist() {
    if (!{{ user.is_authenticated|yesno:"true,false" }}) {
        alert('Please login to add items to wishlist');
        window.location.href = "{% url 'login' %}";
        return;
    }
    
    // Wishlist toggle functionality
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    
    if (button.classList.contains('btn-outline-danger')) {
        button.classList.remove('btn-outline-danger');
        button.classList.add('btn-danger');
        icon.className = 'bi bi-heart-fill';
    } else {
        button.classList.remove('btn-danger');
        button.classList.add('btn-outline-danger');
        icon.className = 'bi bi-heart';
    }
}

// Variant selection
document.querySelectorAll('.variant-option').forEach(option => {
    option.addEventListener('click', function() {
        const variantType = this.closest('.mb-3').querySelector('h6').textContent.replace(':', '').trim();
        const variantId = this.dataset.variantId;
        const priceAdjustment = parseFloat(this.dataset.priceAdjustment || 0);
        
        // Remove active class from siblings
        this.parentNode.querySelectorAll('.variant-option').forEach(sibling => {
            sibling.classList.remove('selected');
        });
        
        // Add active class to clicked option
        this.classList.add('selected');
        
        // Store selected variant
        selectedVariants[variantType] = variantId;
        
        // Update price if there's a price adjustment
        updatePrice();
    });
});

function updatePrice() {
    let totalAdjustment = 0;
    document.querySelectorAll('.variant-option.selected').forEach(option => {
        totalAdjustment += parseFloat(option.dataset.priceAdjustment || 0);
    });
    
    const newPrice = basePrice + totalAdjustment;
    document.querySelector('.price-current').textContent = '$' + newPrice.toFixed(2);
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

function updateCartCount() {
    // Update cart count in navbar if exists
}
</script>
{% endblock %}
